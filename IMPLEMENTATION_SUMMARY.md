# カレンダー共有機能 - 実装完了

## 🎉 実装完了

カレンダー共有機能が正常に実装されました！

## 📋 実装内容

### ✅ 完了した機能

1. **データベーススキーマとマイグレーション**

   - `supabase/add-shared-calendar-constraints.sql` - 制約とトリガーの追加
   - カレンダー作成上限（最大2つ/ユーザー）
   - カレンダーメンバー上限（最大8人/カレンダー）
   - 参加カレンダー上限（最大3つ/ユーザー）
   - 招待コードの自動生成

2. **TypeScript型定義**

   - `src/types/calendar.types.ts` - カレンダー関連の型定義

3. **APIクエリ関数**

   - `src/lib/queries/calendarQueries.ts` - カレンダーCRUD操作
   - リアルタイム更新機能（Supabase Realtime）

4. **UIコンポーネント**

   - `CalendarSelectorModal` - カレンダー選択モーダル
   - `CreateCalendarModal` - カレンダー作成モーダル
   - `ShareCalendarModal` - 招待URL共有モーダル
   - `Calendar` - カレンダー情報表示（アイコン、名前、メンバー）

5. **招待機能**

   - `/invite/[token]` - 招待URL処理ページ
   - カレンダーへの参加フロー
   - 未ログインユーザーのリダイレクト

6. **コンテキスト管理**

   - `CalendarContext` - 現在のカレンダーID管理
   - localStorageへの永続化

7. **UI統合**
   - Header - デスクトップ用カレンダー切り替えボタン
   - Sidebar - デスクトップ用カレンダー切り替えボタン
   - Footer - モバイル用カレンダー切り替えボタン

## 🚀 セットアップ手順

### 1. データベースマイグレーション

Supabaseダッシュボードで以下のSQLを実行：

```bash
# 1. 基本スキーマ（既に実行済みの場合はスキップ）
supabase/schema.sql

# 2. 共有カレンダー制約の追加
supabase/add-shared-calendar-constraints.sql
```

### 2. 開発サーバーの起動

```bash
npm run dev
```

## 📖 使用方法

### カレンダーの作成

1. フッター（モバイル）またはヘッダー/サイドバー（デスクトップ）の「切り替え」ボタンをクリック
2. 「新しいカレンダーを作成」ボタンをクリック
3. カレンダー情報を入力:
   - カレンダー名（必須）
   - 説明（任意）
   - アイコン選択
   - カラー選択
4. 「作成」ボタンをクリック

### カレンダーの共有

1. カレンダー選択モーダルで共有したいカレンダーの共有アイコン（🔗）をクリック
2. 招待URLが表示されます
3. 「コピー」ボタンでURLをクリップボードにコピー
4. 招待したいユーザーにURLを送信

### カレンダーへの参加

1. 受け取った招待URLにアクセス
2. ログインしていない場合は、ログインページにリダイレクト
3. 「カレンダーに参加」ボタンをクリック
4. 参加完了後、自動的にホームページにリダイレクト

### カレンダーの切り替え

1. 「切り替え」ボタンをクリック
2. 参加中のカレンダー一覧から選択
3. カレンダーが切り替わり、ヘッダーに情報が表示されます

## 🎨 UI/UX機能

### カレンダー情報表示

- カレンダーのアイコンと名前
- カレンダーの説明
- メンバー数（X/8）
- メンバーのアバター（最大5人まで表示）

### モーダル機能

- カレンダー選択モーダル
  - 参加中のカレンダー一覧
  - 作成済み/参加可能数の表示
  - 各カレンダーの共有ボタン
- カレンダー作成モーダル
  - アイコン選択（10種類）
  - カラー選択（8色）
  - バリデーション
- 共有URLモーダル
  - ワンクリックでURLコピー
  - メンバー一覧表示
  - 参加可能人数の警告

## ⚠️ 制限事項

### ユーザー制限

- **カレンダー作成**: 最大2つまで
- **カレンダー参加**: 最大3つの共有カレンダーまで（自分が作成したカレンダーは除く）

### カレンダー制限

- **メンバー数**: 最大8人まで（作成者を含む）

これらの制限はデータベーストリガーで強制されているため、フロント側でバイパスすることはできません。

## 🔧 技術スタック

- **フロントエンド**: Next.js 14, React, TypeScript, Tailwind CSS
- **バックエンド**: Supabase (PostgreSQL, Realtime)
- **認証**: Supabase Auth
- **状態管理**: React Context API
- **UI**: カスタムモーダルコンポーネント

## 📁 ファイル構成

```
src/
├── app/
│   ├── _components/
│   │   ├── Calendar.tsx                    # 更新: カレンダー情報表示
│   │   ├── CalendarSelectorModal.tsx       # 新規: カレンダー選択
│   │   ├── CreateCalendarModal.tsx         # 新規: カレンダー作成
│   │   ├── ShareCalendarModal.tsx          # 新規: 招待URL共有
│   │   ├── Header.tsx                      # 更新: 切り替えボタン追加
│   │   ├── Sidebar.tsx                     # 更新: 切り替えボタン追加
│   │   └── Footer.tsx                      # 更新: 切り替えボタン追加
│   ├── context/
│   │   └── CalendarContext.tsx             # 更新: カレンダーID管理
│   └── invite/
│       └── [token]/
│           └── page.tsx                    # 新規: 招待処理
├── lib/
│   └── queries/
│       └── calendarQueries.ts              # 新規: カレンダーAPI
├── types/
│   └── calendar.types.ts                   # 新規: 型定義
└── supabase/
    ├── schema.sql                          # 既存: 基本スキーマ
    └── add-shared-calendar-constraints.sql # 新規: 制約追加
```

## 🐛 トラブルシューティング

### カレンダーが作成できない

**原因**: 既に2つのカレンダーを作成している
**解決策**: 既存のカレンダーを削除してから新規作成

### カレンダーに参加できない

**原因1**: カレンダーのメンバー数が8人に達している
**解決策**: メンバーが退出するまで待つ

**原因2**: 既に3つの共有カレンダーに参加している
**解決策**: 既存のカレンダーから退出してから新規参加

**原因3**: 招待コードが無効
**解決策**: 正しい招待URLを再度取得

### リアルタイム更新が動作しない

**原因**: Supabase Realtimeが無効
**解決策**: SupabaseダッシュボードでRealtimeを有効化

## 🔄 次のステップ（オプション）

実装可能な追加機能：

1. **メンバー管理**

   - メンバーの削除機能
   - 役割の変更（オーナー、編集者、閲覧者）

2. **通知機能**

   - カレンダーへの招待通知
   - メンバー追加通知
   - イベント更新通知

3. **カレンダー設定**

   - 公開/非公開設定
   - 招待コードの再生成
   - カレンダーの削除

4. **検索とフィルタ**
   - カレンダー検索
   - メンバー検索
   - タグによるフィルタリング

## 📚 参考ドキュメント

詳細な実装ガイドは以下を参照：

- [shared-calendar-implementation.md](./shared-calendar-implementation.md)
- [database-schema.md](./database-schema.md)

## ✅ テストチェックリスト

実装後、以下をテストしてください：

- [ ] カレンダーの作成
- [ ] カレンダーの切り替え
- [ ] 招待URLの生成
- [ ] 招待URLでの参加
- [ ] カレンダー情報の表示
- [ ] メンバー一覧の表示
- [ ] 作成上限の確認（3つ目を作成しようとするとエラー）
- [ ] 参加上限の確認（4つ目に参加しようとするとエラー）
- [ ] メンバー上限の確認（9人目が参加しようとするとエラー）
- [ ] 未ログイン状態での招待URL処理

---

**実装完了日**: 2025年10月29日
**バージョン**: 1.0.0
