# カレンダー共有機能 実装ガイド

## 概要

このドキュメントでは、カレンダー共有機能の実装手順と使用方法について説明します。

## 実装された機能

### 1. カレンダー作成と管理

- ユーザーは最大2つのカレンダーを作成可能
- 各カレンダーにはアイコン、カラー、説明を設定可能
- 自動で一意の招待コードが生成される

### 2. カレンダー共有

- 各カレンダーには最大8人まで参加可能（作成者を含む）
- 招待URLを通じて他のユーザーを招待
- ユーザーは最大3つの共有カレンダーに参加可能

### 3. リアルタイム更新

- Supabase Realtimeを使用してカレンダーとメンバーの変更を即座に反映
- メンバー追加、カレンダー情報の更新がリアルタイムで同期

### 4. UI/UX

- フッターの「切り替え」ボタンからカレンダー選択モーダルを表示
- カレンダー一覧、新規作成、共有URLのコピーが可能
- 招待URL経由での参加フロー

## セットアップ手順

### 1. データベースマイグレーション

Supabaseのダッシュボードで以下のSQLファイルを順番に実行してください：

#### 1.1 基本スキーマの適用

まず `supabase/schema.sql` を実行して基本的なテーブルを作成します。

#### 1.2 共有カレンダー制約の追加

次に `supabase/add-shared-calendar-constraints.sql` を実行します：

```sql
-- このファイルは以下を実装します：
-- 1. カレンダーにiconカラムを追加
-- 2. ユーザーあたりのカレンダー作成数制限（最大2つ）
-- 3. カレンダーあたりのメンバー数制限（最大8人）
-- 4. ユーザーあたりの参加カレンダー数制限（最大3つ）
-- 5. 招待コードの自動生成
```

### 2. 環境変数の確認

`.env.local` ファイルに以下の環境変数が設定されていることを確認：

```env
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
```

### 3. 依存パッケージのインストール

```bash
npm install
```

### 4. 開発サーバーの起動

```bash
npm run dev
```

## 使用方法

### カレンダーの作成

1. フッターの「切り替え」ボタンをクリック
2. 「新しいカレンダーを作成」ボタンをクリック
3. カレンダー名、説明、アイコン、カラーを選択
4. 「作成」ボタンをクリック

### カレンダーの共有

1. カレンダー選択モーダルで共有したいカレンダーの共有アイコンをクリック
2. 招待URLをコピー
3. 招待したいユーザーにURLを送信

### カレンダーへの参加

1. 招待URLにアクセス
2. ログインしていない場合はログイン
3. 「カレンダーに参加」ボタンをクリック

### カレンダーの切り替え

1. フッターの「切り替え」ボタンをクリック
2. 参加中のカレンダー一覧から選択

## ファイル構成

```
src/
├── app/
│   ├── _components/
│   │   ├── CalendarSelectorModal.tsx    # カレンダー選択モーダル
│   │   ├── CreateCalendarModal.tsx      # カレンダー作成モーダル
│   │   ├── ShareCalendarModal.tsx       # 共有URLモーダル
│   │   └── Footer.tsx                   # 更新されたフッター
│   ├── context/
│   │   └── CalendarContext.tsx          # カレンダー状態管理
│   └── invite/
│       └── [token]/
│           └── page.tsx                 # 招待URL処理ページ
├── lib/
│   └── queries/
│       └── calendarQueries.ts           # カレンダーAPI関数
├── types/
│   └── calendar.types.ts                # TypeScript型定義
└── supabase/
    ├── schema.sql                       # 基本スキーマ
    └── add-shared-calendar-constraints.sql  # 制約とトリガー
```

## API関数

### calendarQueries.ts

- `getUserCalendars()` - ユーザーの全カレンダーを取得
- `getCalendarById(id)` - IDでカレンダーを取得
- `getCalendarByInviteCode(code)` - 招待コードでカレンダーを取得
- `createCalendar(input)` - 新しいカレンダーを作成
- `updateCalendar(id, input)` - カレンダーを更新
- `deleteCalendar(id)` - カレンダーを削除
- `joinCalendar(inviteCode)` - 招待コードでカレンダーに参加
- `leaveCalendar(calendarId)` - カレンダーから退出
- `getCalendarStats()` - ユーザーの統計情報を取得
- `getInviteUrl(inviteCode)` - 招待URLを生成
- `subscribeToCalendar(id, callback)` - カレンダー変更をリアルタイム購読
- `subscribeToCalendarMembers(id, callback)` - メンバー変更をリアルタイム購読

## 制限事項

1. **カレンダー作成**: 各ユーザーは最大2つまで
2. **カレンダーメンバー**: 各カレンダーは最大8人まで（作成者を含む）
3. **参加カレンダー**: 各ユーザーは最大3つの共有カレンダーに参加可能

これらの制限はデータベーストリガーで強制されます。

## トラブルシューティング

### カレンダーが作成できない

- 既に2つのカレンダーを作成していないか確認
- データベースのトリガーが正しく設定されているか確認

### カレンダーに参加できない

- カレンダーのメンバー数が8人に達していないか確認
- 既に3つのカレンダーに参加していないか確認
- 招待コードが正しいか確認

### リアルタイム更新が動作しない

- Supabase RealtimeがプロジェクトでEnabledになっているか確認
- ネットワーク接続を確認

## 今後の拡張

以下の機能を追加で実装することができます：

1. **カレンダーメンバーの役割管理**

   - オーナー、編集者、閲覧者の権限を実装

2. **カレンダーの詳細設定**

   - カレンダーの公開/非公開設定
   - メンバーの削除機能

3. **通知機能**

   - カレンダーへの招待通知
   - メンバー追加通知

4. **Header/Sidebarへの統合**
   - デスクトップビューでも同じ機能を提供
